# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
npm run dev      # Start development server (http://localhost:3000)
npm run build    # Production build
npm run start    # Start production server
npm run lint     # Run ESLint
```

## Architecture

This is a Next.js 16 project using:
- **App Router** with pages in `src/app/`
- **TypeScript** with strict mode
- **Tailwind CSS v4** for styling
- **React 19**

### Import Alias

Use `@/*` to import from `src/*`:
```typescript
import { Component } from "@/components/Component";
```

### Fonts

Geist and Geist Mono fonts are configured via `next/font/google` in `layout.tsx` using CSS variables `--font-geist-sans` and `--font-geist-mono`.

---

## Puyo Puyo Game Requirements

### Overview

初代スーパーファミコン版ぷよぷよ風のレトロデザインを持つパズルゲーム。

### Game Rules

#### Board
- **サイズ**: 6列 × 13行 (上部1行は非表示のバッファ)
- **表示領域**: 6列 × 12行
- **ゲームオーバー条件**: 3列目の上部2行にぷよが積まれた場合

#### Puyo
- **色**: 5色 (赤、青、緑、黄、紫)
- **形状**: 2つのぷよが縦に連結した組ぷよ
- **消去条件**: 同色4つ以上が隣接で消去

#### Chain System
- 消去後に落下したぷよが再度4つ以上連結すると連鎖発生
- 連鎖数に応じてスコア倍率が増加 (2^(chain-1))
- スコア = 消去数 × 10 × 倍率

#### Level System
- 30個消去ごとにレベルアップ
- レベルが上がると落下速度が増加
- 落下間隔: max(100ms, 800ms - (level-1) × 50ms)

### Controls

| Input | Action |
|-------|--------|
| ← → | 左右移動 |
| ↓ | ソフトドロップ (1段落下) |
| ↑ / Space | ハードドロップ (即座に設置) |
| Z | 反時計回り回転 |
| X | 時計回り回転 |
| P / Escape | ポーズ切替 |
| R | リスタート (ゲームオーバー時のみ) |

モバイルではタッチボタンによる操作も可能。

### UI/UX Requirements

#### Visual Design (SFC Retro Style)
- 宇宙をイメージしたダーク背景 (#000020 ~ #000040)
- 星空エフェクト (瞬く星)
- パネル: 紫系グラデーション (#4A4A8C ~ #2A2A5C) + 枠線 (#8888CC)
- フォント: monospace、ゴールド (#FFD700) のテキストシャドウ
- ぷよ: SVGで描画、大きな目とハイライト付き

#### Color Palette
- **Red**: #E53935 (light: #FF6F60, dark: #AB000D)
- **Blue**: #1E88E5 (light: #6AB7FF, dark: #005CB2)
- **Green**: #43A047 (light: #76D275, dark: #00701A)
- **Yellow**: #FDD835 (light: #FFFF6B, dark: #C6A700)
- **Purple**: #8E24AA (light: #C158DC, dark: #5C007A)

#### Animations (CSS)
- `twinkle`: 星の瞬きアニメーション
- `puyo-clear`: 消去時の拡大→縮小→フェードアウト
- `chain-pop`: 連鎖表示のポップアップ

#### Panels
- **Next Panel**: 次の組ぷよを表示
- **Score Panel**: スコア (8桁0埋め)、レベル、消去数を表示
- **Controls Panel**: 操作説明 (PC) / レトロボタン (モバイル)

### File Structure

```
src/
├── app/
│   ├── page.tsx          # Entry point
│   └── layout.tsx        # Root layout with metadata
├── components/
│   ├── PuyoGame.tsx      # Main game container
│   ├── GameBoard.tsx     # Board rendering
│   ├── PuyoCell.tsx      # Individual puyo rendering
│   ├── NextPuyo.tsx      # Next piece preview
│   ├── ScorePanel.tsx    # Score/level display
│   ├── Controls.tsx      # Control hints & touch buttons
│   └── GameOverlay.tsx   # Pause/GameOver screens
├── hooks/
│   └── useGameEngine.ts  # Game logic & state management
└── types/
    └── game.ts           # TypeScript type definitions
```

### State Management

`useGameEngine` hook manages:
- `board`: 2D array of Puyo cells
- `currentPuyo`: Currently falling piece
- `nextPuyo`: Next piece preview
- `score`, `level`, `chainCount`, `clearedPuyos`
- `isGameOver`, `isPaused`

Game loop runs via `setInterval`, speed adjusts by level.

---

## Requirements Specification

### Functional Requirements

#### Core Gameplay
1. **ぷよの落下**
   - 組ぷよ（2つのぷよが縦に連結）が上から落下する
   - 落下速度はレベルに応じて変化する
   - 下方向キーでソフトドロップ（1段落下）が可能
   - 上方向キーまたはスペースでハードドロップ（即座に設置）が可能

2. **ぷよの操作**
   - 左右キーで水平移動（壁や他のぷよに衝突するまで）
   - Zキーで反時計回り回転、Xキーで時計回り回転
   - 回転時に壁や他のぷよに衝突する場合は回転不可

3. **消去システム**
   - 同色のぷよが4つ以上隣接（上下左右）している場合に消去
   - 消去時にアニメーション（拡大→縮小→フェードアウト）を表示
   - 消去後、上のぷよが落下する
   - 落下後に再度4つ以上連結すると連鎖が発生

4. **連鎖システム**
   - 連鎖数に応じてスコア倍率が増加（2^(chain-1)）
   - 連鎖時にポップアップ表示（"CHAIN X"）
   - スコア計算: 消去数 × 10 × 倍率

5. **レベルシステム**
   - 30個のぷよを消去するごとにレベルアップ
   - レベルが上がると落下速度が増加
   - 落下間隔の計算式: max(100ms, 800ms - (level-1) × 50ms)

6. **ゲームオーバー**
   - 3列目の上部2行（非表示バッファ含む）にぷよが積まれた場合にゲームオーバー
   - ゲームオーバー時にオーバーレイを表示
   - Rキーでリスタート可能

7. **ポーズ機能**
   - PキーまたはEscapeキーでポーズ/再開を切り替え
   - ポーズ中はゲームループを停止

#### UI/UX Features
1. **表示パネル**
   - Next Panel: 次の組ぷよをプレビュー表示
   - Score Panel: スコア（8桁0埋め）、レベル、消去数を表示
   - Controls Panel: PCでは操作説明、モバイルではタッチボタンを表示

2. **視覚効果**
   - 星空エフェクト（瞬く星のアニメーション）
   - レトロなSFC風デザイン
   - ぷよのSVG描画（大きな目とハイライト付き）

3. **レスポンシブデザイン**
   - PCとモバイルの両方に対応
   - モバイルではタッチボタンによる操作を提供

### Non-Functional Requirements

#### Performance Requirements
1. **フレームレート**
   - ゲームループは60fpsを目標とする
   - アニメーションは滑らかに動作すること

2. **レスポンス時間**
   - キー入力から画面更新までの遅延は100ms以下
   - ぷよの落下、移動、回転は即座に反映されること

3. **メモリ使用量**
   - 長時間プレイしてもメモリリークが発生しないこと
   - 不要なDOM要素やイベントリスナーを適切にクリーンアップすること

#### Browser Compatibility
1. **対応ブラウザ**
   - Chrome (最新版)
   - Firefox (最新版)
   - Safari (最新版)
   - Edge (最新版)
   - モバイルブラウザ（iOS Safari、Chrome Mobile）

2. **機能要件**
   - ES6+の機能を使用可能
   - CSS Grid/Flexboxを使用可能
   - SVG描画に対応

#### Responsive Design Requirements
1. **画面サイズ**
   - デスクトップ: 1024px以上
   - タブレット: 768px - 1023px
   - モバイル: 320px - 767px

2. **タッチ操作**
   - モバイルではタッチボタンを表示
   - タッチボタンは十分なサイズ（最小44px × 44px）を確保
   - タッチ操作は誤操作を防ぐため適切なフィードバックを提供

#### Accessibility Requirements
1. **キーボード操作**
   - すべての機能がキーボードで操作可能
   - フォーカス可能な要素には適切なフォーカス表示

2. **視覚的アクセシビリティ**
   - 色だけでなく形状でも区別できる（将来的な拡張）
   - 十分なコントラスト比を確保（WCAG 2.1 AA準拠）

### Technical Requirements

#### Code Quality
1. **TypeScript**
   - strict modeを有効化
   - すべての型を明示的に定義
   - any型の使用を避ける

2. **ESLint**
   - コード品質を維持するためESLintを実行
   - エラーは修正必須、警告は可能な限り修正

3. **コンポーネント設計**
   - 単一責任の原則に従う
   - 再利用可能なコンポーネントを設計
   - Propsの型を明示的に定義

#### Error Handling
1. **ゲームロジックエラー**
   - 不正な状態（例: ボード外への配置）を検出して防止
   - エラー発生時は適切なフォールバック処理を実装

2. **ユーザー入力エラー**
   - 無効な入力は無視するか、適切なフィードバックを提供
   - キーリピートを適切に処理

#### State Management
1. **状態の一貫性**
   - ゲーム状態は常に一貫性を保つこと
   - 状態の更新は予測可能であること

2. **パフォーマンス**
   - 不要な再レンダリングを避ける（React.memo、useMemo、useCallbackの適切な使用）
   - ゲームループは効率的に実装すること

### Testing Requirements

#### Unit Tests
1. **ゲームロジック**
   - ぷよの移動、回転、落下のロジック
   - 消去判定のロジック
   - 連鎖判定のロジック
   - スコア計算のロジック

#### Integration Tests
1. **コンポーネント連携**
   - ゲームエンジンとUIコンポーネントの連携
   - キー入力とゲーム状態の更新

#### E2E Tests (Optional)
1. **ユーザーフロー**
   - ゲーム開始から終了までのフロー
   - モバイルでのタッチ操作

### Deployment Requirements

1. **ビルド**
   - `npm run build`でエラーなくビルドできること
   - 本番環境で動作すること

2. **環境変数**
   - 環境変数が必要な場合は適切に設定すること

3. **パフォーマンス**
   - Lighthouseスコア: Performance 80以上を目標
   - First Contentful Paint (FCP): 1.8秒以下
   - Largest Contentful Paint (LCP): 2.5秒以下

---

## Game Enhancement Ideas

### Gameplay Enhancements

#### 1. 特殊ぷよシステム
- **おじゃまぷよ（灰色）**
  - 一定のスコアや連鎖数に達すると降ってくる
  - 4つ以上連結で消去可能（通常のぷよと同様）
  - 消去時は通常のぷよより多くのスコアを獲得

- **虹色ぷよ（ワイルドカード）**
  - 稀に出現する特殊ぷよ
  - どの色とも連結して消去可能
  - 連鎖の起点として強力

- **爆弾ぷよ**
  - 消去時に周囲のぷよも一緒に消去
  - 範囲は3×3マス
  - 連鎖を引き起こしやすい

#### 2. パワーアップアイテム
- **スローモーション**
  - 一定時間、落下速度が半分になる
  - 高レベルでの戦略的プレイを支援

- **色統一**
  - 次の組ぷよが全て同じ色になる
  - 連鎖を組みやすくなる

- **クリアライン**
  - 指定した行を一括で消去
  - 緊急時の脱出手段

#### 3. モード追加
- **タイムアタックモード**
  - 制限時間内にできるだけ多くのスコアを獲得
  - 時間が経つと落下速度が加速

- **エンドレスモード**
  - ゲームオーバーまでプレイし続ける
  - ハイスコアを記録

- **チャレンジモード**
  - 特定の条件をクリアする（例: 10連鎖達成、特定のスコア達成）
  - 難易度別のチャレンジを用意

- **パズルモード**
  - あらかじめ配置されたぷよを全て消去する
  - 最適解を目指すパズル要素

#### 4. コンボシステム
- **コンボボーナス**
  - 短時間内に連続で消去するとコンボが発生
  - コンボ数に応じてスコア倍率が増加
  - コンボ表示のアニメーション

- **パーフェクトクリア**
  - ボードを全てクリアすると特別ボーナス
  - 非常に稀な達成で高得点

#### 5. スキルシステム
- **習得スキル**
  - プレイ回数や達成度に応じてスキルを解放
  - 例: 「開始時に3秒のスローモーション」「最初の連鎖で2倍ボーナス」

- **スキルツリー**
  - スキルを選択してカスタマイズ
  - プレイスタイルに合わせて強化

### Visual & Audio Enhancements

#### 1. エフェクト強化
- **画面シェイク**
  - 大きな連鎖時に画面が揺れる
  - インパクトのある演出

- **パーティクルエフェクト**
  - 消去時に星や光のパーティクルが飛び散る
  - 連鎖数に応じてエフェクトが派手に

- **背景変化**
  - レベルや連鎖数に応じて背景が変化
  - 例: レベル10で背景が赤く、レベル20で紫に

- **ぷよの表情変化**
  - 連鎖が近づくとぷよが緊張した表情に
  - 消去時に喜びの表情

#### 2. サウンドシステム
- **BGM**
  - レベルに応じてBGMが変化
  - レトロなチップチューン風の音楽

- **効果音**
  - ぷよの落下音、消去音、連鎖音
  - 各アクションに適切な効果音を配置
  - 連鎖数に応じて音が派手に

- **ボイス**
  - 連鎖時に「連鎖！」「大連鎖！」などのボイス
  - レトロな合成音声

#### 3. アニメーション強化
- **ぷよのアニメーション**
  - ぷよが呼吸するように動く
  - 落下時に回転アニメーション
  - 消去前の「危険」アニメーション（点滅）

- **UIアニメーション**
  - スコアが増加する際の数字のアニメーション
  - レベルアップ時の画面全体のエフェクト
  - パネルの登場アニメーション

### Social & Competitive Features

#### 1. ランキングシステム
- **ローカルランキング**
  - ブラウザのLocalStorageにハイスコアを保存
  - トップ10を表示

- **オンラインランキング（将来的）**
  - サーバーにスコアを送信
  - グローバルランキングを表示
  - 日次/週次/月次のランキング

#### 2. 実績システム
- **アチーブメント**
  - 「初めての連鎖」「10連鎖達成」「スコア100万点」など
  - 達成時にバッジを表示
  - 実績一覧画面

- **統計情報**
  - 総プレイ時間、総消去数、最大連鎖数など
  - プレイ履歴の可視化

#### 3. リプレイ機能
- **リプレイ保存**
  - ハイスコア達成時のリプレイを自動保存
  - リプレイを再生して見返せる

- **リプレイ共有**
  - リプレイデータをエクスポート/インポート
  - 友達と共有可能

### Quality of Life Improvements

#### 1. 操作性の向上
- **ホールド機能**
  - 現在の組ぷよを一時的に保持
  - 次の組ぷよと入れ替え可能
  - Cキーでホールド/リリース

- **ゴースト表示**
  - ハードドロップ時の着地点を半透明で表示
  - 配置の見通しが良くなる

- **次の次のぷよ表示**
  - 次の組ぷよだけでなく、その次の組ぷよも表示
  - より先読みした戦略が可能

#### 2. カスタマイズ機能
- **テーマ選択**
  - 複数のカラーテーマを用意
  - 例: クラシック、ネオン、パステル、モノクロ

- **操作設定**
  - キーバインドをカスタマイズ可能
  - 左右移動の速度調整
  - 回転の感度調整

- **難易度設定**
  - イージー/ノーマル/ハード
  - 開始レベル、落下速度の調整

#### 3. チュートリアル・ヘルプ
- **インタラクティブチュートリアル**
  - 初回プレイ時に操作方法を説明
  - 実際に操作しながら学べる

- **ヒントシステム**
  - 一定時間操作がない場合、ヒントを表示
  - 「ここに置くと連鎖できます」など

- **戦略ガイド**
  - 連鎖の組み方、テクニックを解説
  - 初心者向けのガイド

### Advanced Features

#### 1. AI対戦モード（将来的）
- **AI対戦**
  - コンピュータと対戦
  - 難易度別のAIを用意

#### 2. マルチプレイヤー（将来的）
- **オンライン対戦**
  - リアルタイムで他のプレイヤーと対戦
  - おじゃまぷよを送り合う

- **ローカル対戦**
  - 同じ画面で2人対戦
  - 分割画面で同時プレイ

#### 3. エディタモード
- **ステージエディタ**
  - カスタムステージを作成
  - ぷよの配置を自由に設定
  - 作成したステージを保存・共有

#### 4. デイリーチャレンジ
- **毎日のチャレンジ**
  - 毎日新しいチャレンジが配信
  - 全員が同じ条件で競う
  - 達成者に特別な報酬

### Technical Enhancements

#### 1. パフォーマンス最適化
- **60fps維持**
  - アニメーションの最適化
  - 不要な再レンダリングの削減

- **メモリ管理**
  - 長時間プレイでもメモリリークなし
  - 効率的なデータ構造の使用

#### 2. アクセシビリティ
- **色覚多様性対応**
  - 色だけでなく形状でも区別可能
  - カラーフィルターの選択

- **難易度調整**
  - 視覚障害者向けの設定
  - 操作の簡略化オプション

#### 3. オフライン対応
- **PWA対応**
  - オフラインでもプレイ可能
  - ホーム画面に追加可能

### Retro Gaming Features

#### 1. レトロ要素の強化
- **スコア表示**
  - 7セグメントディスプレイ風の数字表示
  - アナログメーター風のレベル表示

- **ピクセルアート**
  - より本格的なピクセルアートスタイル
  - ドット絵風のアニメーション

- **レトロUI**
  - スーパーファミコン風のメニュー画面
  - レトロな効果音とBGM

#### 2. ノスタルジック要素
- **クラシックモード**
  - 初代ぷよぷよの完全再現モード
  - オリジナルのルールとデザイン

- **タイムカプセル**
  - 過去のバージョンでプレイ可能
  - ゲームの進化を体験

### Implementation Priority

#### Phase 1 (高優先度・実装容易)
- ホールド機能
- ゴースト表示
- 実績システム
- ローカルランキング
- エフェクト強化（パーティクル、画面シェイク）

#### Phase 2 (中優先度・中程度の実装)
- 特殊ぷよシステム（おじゃまぷよ、虹色ぷよ）
- タイムアタックモード
- チャレンジモード
- サウンドシステム（BGM、効果音）
- カスタマイズ機能（テーマ、操作設定）

#### Phase 3 (低優先度・実装困難)
- オンラインランキング
- マルチプレイヤー対戦
- AI対戦モード
- エディタモード
- PWA対応
